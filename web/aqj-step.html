<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>AQ-J 1回答1画面形式</title>
    <link rel="stylesheet" href="./aqj.css" />
  </head>
  <body>
    <div class="page">
      <div class="app-shell">
        <header>
          <p class="status-pill">AQ-J モバイルデモ · Step</p>
          <h1>AQ 日本語版 1回答1画面フロー</h1>
          <p class="lead">
            1つの質問を1画面ずつ表示し、回答すると自動で次の質問に進みます。集中して回答しつつ、必要なときだけ前の質問に戻れます。
          </p>
          <div class="progress-indicator" role="status" aria-live="polite">
            <span class="progress-text" data-step-progress-text>1 / 50</span>
            <div class="progress-bar" aria-hidden="true">
              <div class="progress-bar-fill" data-step-progressbar></div>
            </div>
          </div>
          <p class="range-label" data-step-progress-subtext>回答済 0 問 · 残り 50 問</p>
        </header>

        <div class="status-banner error" data-step-status hidden></div>

        <section class="instructions-card">
          <h2>回答のしかた</h2>
          <div data-step-instructions></div>
        </section>

        <div class="answer-dot-bar" data-step-dots></div>

        <main class="question-stack" aria-label="AQ-J 質問" data-step-question></main>

        <div class="nav-buttons" data-step-nav>
          <button class="button secondary" data-step-prev disabled>前の質問へ</button>
          <button class="button primary" data-step-skip>次の質問へ</button>
        </div>

        <section class="summary-card" data-step-summary hidden></section>
      </div>
    </div>

    <script type="module">
      import {
        AQJ_QUESTIONS,
        AQJ_SCALE,
        createRadioOption,
        formatQuestionId,
        createAnswerStore,
        summarizeAnswers,
        createInstructionsList
      } from "./aqj.js";

      const total = AQJ_QUESTIONS.length;
      const store = createAnswerStore();
      let currentIndex = 0; // 0-based index

      const instructionsContainer = document.querySelector("[data-step-instructions]");
      const questionContainer = document.querySelector("[data-step-question]");
      const statusBanner = document.querySelector("[data-step-status]");
      const progressText = document.querySelector("[data-step-progress-text]");
      const progressBar = document.querySelector("[data-step-progressbar]");
      const progressSubtext = document.querySelector("[data-step-progress-subtext]");
      const dotsContainer = document.querySelector("[data-step-dots]");
      const navContainer = document.querySelector("[data-step-nav]");
      const prevButton = document.querySelector("[data-step-prev]");
      const skipButton = document.querySelector("[data-step-skip]");
      const summaryCard = document.querySelector("[data-step-summary]");

      createInstructionsList(instructionsContainer);

      function hideStatus() {
        statusBanner.hidden = true;
        statusBanner.textContent = "";
        statusBanner.classList.remove("error", "success", "warning");
      }

      function showStatus(type, message) {
        statusBanner.hidden = false;
        statusBanner.classList.remove("error", "success", "warning");
        statusBanner.classList.add(type);
        statusBanner.textContent = message;
      }

      function updateProgressMeta() {
        const answered = store.getAnsweredCount();
        progressText.textContent = `${currentIndex + 1} / ${total}`;
        progressSubtext.textContent = `回答済 ${answered} 問 · 残り ${total - answered} 問`;
        const percent = (answered / total) * 100;
        progressBar.style.width = `${percent}%`;

        dotsContainer.innerHTML = "";
        AQJ_QUESTIONS.forEach((_, idx) => {
          const dot = document.createElement("span");
          dot.className = "answer-dot";
          if (store.get(idx + 1)) {
            dot.classList.add("answered");
          }
          if (idx === currentIndex) {
            dot.style.boxShadow = "0 0 0 3px rgba(37, 99, 235, 0.35)";
          }
          dot.setAttribute("title", `Q${idx + 1} ${store.get(idx + 1) ? "回答済" : "未回答"}`);
          dotsContainer.appendChild(dot);
        });
      }

      function showQuestionView() {
        summaryCard.hidden = true;
        summaryCard.style.display = "none";
        questionContainer.hidden = false;
        questionContainer.style.display = "";
        navContainer.hidden = false;
        navContainer.style.display = "";
      }

      function enterSummaryView() {
        questionContainer.hidden = true;
        questionContainer.style.display = "none";
        navContainer.hidden = true;
        navContainer.style.display = "none";
        summaryCard.hidden = false;
        summaryCard.style.display = "";
      }

      function renderCurrentQuestion() {
        const question = AQJ_QUESTIONS[currentIndex];
        questionContainer.innerHTML = "";

        const card = document.createElement("article");
        card.className = "question-card";
        card.classList.add(question.id % 2 === 1 ? "step-card-odd" : "step-card-even");
        card.id = `question-card-${question.id}`;

        const fieldset = document.createElement("fieldset");
        const legend = document.createElement("legend");
        legend.textContent = `Q${question.id}. ${question.text}`;
        fieldset.appendChild(legend);

        const choices = document.createElement("div");
        choices.className = "choices";

        AQJ_SCALE.forEach((option) => {
          const optionNode = createRadioOption(option, formatQuestionId(question.id), store.get(question.id));
          const input = optionNode.querySelector("input");
          input.id = `${formatQuestionId(question.id)}-${option.value}`;
          const desc = optionNode.querySelector(".choice-desc");
          if (desc) {
            const descId = `${formatQuestionId(question.id)}-${option.value}-desc`;
            desc.id = descId;
            input.setAttribute("aria-describedby", descId);
          }
          input.addEventListener("change", () => {
            store.set(question.id, input.value);
            card.classList.remove("invalid");
            hideStatus();
            handleAnswered();
          });
          choices.appendChild(optionNode);
        });

        fieldset.appendChild(choices);
        card.appendChild(fieldset);
        questionContainer.appendChild(card);

        prevButton.disabled = currentIndex === 0;
        skipButton.textContent = currentIndex === total - 1 ? "サマリーへ進む" : "次の質問へ";
        updateProgressMeta();
      }

      function focusQuestion(questionId) {
        const clamped = Math.min(Math.max(questionId - 1, 0), total - 1);
        currentIndex = clamped;
        showQuestionView();
        hideStatus();
        renderCurrentQuestion();
        questionContainer.scrollIntoView({ behavior: "smooth", block: "start" });
        const card = document.getElementById(`question-card-${questionId}`);
        if (card) {
          card.classList.add("invalid");
        }
      }

      function renderSummary() {
        const summaryInfo = summarizeAnswers(store, { allowIncomplete: true });

        if (summaryInfo.missingQuestionIds.length) {
          showStatus("warning", `未回答が ${summaryInfo.missingQuestionIds.length} 問あります。サマリーで一覧を確認してください。`);
        } else {
          showStatus("success", "全50問の回答を記録しました。");
        }

        summaryCard.innerHTML = `
          <h2>回答サマリー</h2>
          <p>${summaryInfo.answeredCount}/${summaryInfo.total} の回答を記録しました。</p>
        `;

        if (summaryInfo.missingQuestionIds.length) {
          const note = document.createElement("p");
          note.className = "range-label";
          note.textContent = `未回答 ${summaryInfo.missingQuestionIds.length} 問: ${summaryInfo.missingQuestionIds
            .map((id) => `Q${id}`)
            .join(", ")}`;
          summaryCard.appendChild(note);
        }

        const table = document.createElement("table");
        table.className = "summary-table";
        table.innerHTML = "<thead><tr><th>番号</th><th>回答</th><th>質問文</th></tr></thead>";
        const tbody = document.createElement("tbody");
        summaryInfo.entries.forEach((entry) => {
          const row = document.createElement("tr");
          row.innerHTML = `<td>Q${entry.id}</td><td>${entry.label}</td><td>${entry.text}</td>`;
          tbody.appendChild(row);
        });
        table.appendChild(tbody);
        summaryCard.appendChild(table);

        const actions = document.createElement("div");
        actions.className = "summary-actions";

        if (summaryInfo.missingQuestionIds.length) {
          const focusBtn = document.createElement("button");
          focusBtn.className = "button primary";
          focusBtn.type = "button";
          focusBtn.textContent = "未回答に戻る";
          focusBtn.addEventListener("click", () => focusQuestion(summaryInfo.missingQuestionIds[0]));
          actions.appendChild(focusBtn);
        }

        const backBtn = document.createElement("button");
        backBtn.className = "button secondary";
        backBtn.type = "button";
        backBtn.textContent = "質問に戻る";
        backBtn.addEventListener("click", () => {
          showQuestionView();
          hideStatus();
          renderCurrentQuestion();
          questionContainer.scrollIntoView({ behavior: "smooth", block: "start" });
        });
        actions.appendChild(backBtn);
        summaryCard.appendChild(actions);
      }

      function handleAnswered() {
        const atLastQuestion = currentIndex === total - 1;
        if (atLastQuestion) {
          // Q50 のカードを非表示にしてからサマリーだけを表示する
          questionContainer.innerHTML = "";
          enterSummaryView();
          updateProgressMeta();
          renderSummary();
          return;
        }
        currentIndex += 1;
        renderCurrentQuestion();
      }

      function handleSkip() {
        const atLastQuestion = currentIndex === total - 1;
        if (atLastQuestion) {
          // 未回答のままでもサマリーへ進む
          questionContainer.innerHTML = "";
          enterSummaryView();
          updateProgressMeta();
          renderSummary();
          return;
        }
        currentIndex += 1;
        renderCurrentQuestion();
      }

      prevButton.addEventListener("click", () => {
        if (currentIndex === 0) return;
        showQuestionView();
        hideStatus();
        currentIndex -= 1;
        renderCurrentQuestion();
      });

      skipButton.addEventListener("click", () => {
        showQuestionView();
        hideStatus();
        handleSkip();
      });

      renderCurrentQuestion();
    </script>
  </body>
</html>


